name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-C debuginfo=0"
  RUSTDOCFLAGS: "-Dwarnings"

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
    - name: ğŸ“‚ Checkout code
      uses: actions/checkout@v6

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Install cargo-insta
      uses: baptiste0928/cargo-install@v3
      with:
        crate: cargo-insta

    - name: Install cargo-nextest
      uses: baptiste0928/cargo-install@v3
      with:
        crate: cargo-nextest

    - name: ğŸ’° Cache
      uses: Swatinem/rust-cache@v2
      with:
        prefix-key: v0-rust
        save-if: ${{ github.ref == 'refs/heads/main' }}

    - name: Install shells (bash, zsh, fish) - Ubuntu
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y zsh fish

    - name: Install shells (bash, zsh, fish) - macOS
      if: runner.os == 'macOS'
      run: |
        brew install fish
        # bash and zsh are pre-installed on macOS

    - name: Install shells - Windows
      if: runner.os == 'Windows'
      run: |
        # Git Bash is pre-installed on GitHub Actions Windows runners
        # Fish and zsh are not commonly available on native Windows (require WSL/MSYS2)
        # CI will test with bash only on Windows
        echo "Using Git Bash for Windows tests"
      shell: pwsh

    - name: ğŸ­ Compile
      uses: clechasseur/rs-cargo@v4
      with:
        command: test
        args: --no-run --locked ${{ runner.os != 'Windows' && '--features shell-integration-tests' || '' }}

    - name: ğŸ”§ Build test helpers
      if: runner.os != 'Windows'
      run: cargo build -p dev-detach

    - name: ğŸ“‹ Test
      uses: clechasseur/rs-cargo@v4
      timeout-minutes: 10
      with:
        command: insta
        args: test --test-runner=nextest ${{ runner.os != 'Windows' && '--features shell-integration-tests' || '' }}

    - name: ğŸ“– Doctest
      uses: clechasseur/rs-cargo@v4
      with:
        command: test
        args: --doc --locked

    - name: ğŸ“ Clippy
      uses: clechasseur/rs-cargo@v4
      with:
        command: clippy
        args: --all-targets --all-features -- -D warnings

    - name: âŒ¨ï¸ Fmt
      uses: clechasseur/rs-cargo@v4
      with:
        command: fmt
        args: --all --check

    - name: ğŸ—’ï¸ Doc
      uses: clechasseur/rs-cargo@v4
      with:
        command: doc
        args: --no-deps

  check-links:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“‚ Checkout code
      uses: actions/checkout@v6

    - name: Install lychee
      uses: baptiste0928/cargo-install@v3
      with:
        crate: lychee

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.12"

    - name: Install pre-commit
      run: pip install pre-commit

    - name: Get modified markdown files
      if: github.event_name == 'pull_request'
      id: changed-files
      uses: tj-actions/changed-files@v47
      with:
        files: |
          **/*.md

    - name: Link checker (modified files - PRs)
      if: github.event_name == 'pull_request' && steps.changed-files.outputs.any_modified == 'true'
      run: pre-commit run lychee --files ${{ steps.changed-files.outputs.all_changed_files }}

    - name: Link checker (all files - main branch)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: pre-commit run lychee --all-files

  # Check if Cargo files changed (for conditional jobs below)
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      cargo: ${{ steps.filter.outputs.cargo }}
    steps:
    - name: ğŸ“‚ Checkout code
      uses: actions/checkout@v6
    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          cargo:
            - 'Cargo.toml'
            - 'Cargo.lock'
            - 'rust-toolchain.toml'

  msrv:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.cargo == 'true' || github.event_name == 'workflow_dispatch'
    steps:
    - name: ğŸ“‚ Checkout code
      uses: actions/checkout@v6

    - name: ğŸ’° Cache
      uses: Swatinem/rust-cache@v2
      with:
        prefix-key: v0-msrv
        save-if: ${{ github.ref == 'refs/heads/main' }}

    - uses: baptiste0928/cargo-install@v3
      with:
        crate: cargo-msrv

    - name: Verify minimum rust version
      run: cargo msrv verify

  check-unused-dependencies:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.cargo == 'true' || github.event_name == 'workflow_dispatch'
    steps:
    - name: ğŸ“‚ Checkout code
      uses: actions/checkout@v6

    # cargo-udeps requires nightly; update date periodically
    - run: rustup override set nightly-2025-11-10

    - name: ğŸ’° Cache
      uses: Swatinem/rust-cache@v2
      with:
        prefix-key: v0-udeps
        save-if: ${{ github.ref == 'refs/heads/main' }}

    - uses: baptiste0928/cargo-install@v3
      with:
        crate: cargo-udeps

    - uses: clechasseur/rs-cargo@v4
      with:
        command: udeps
        args: --all-targets --locked

  benchmarks:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.cargo == 'true' || github.event_name == 'workflow_dispatch'
    steps:
    - name: ğŸ“‚ Checkout code
      uses: actions/checkout@v6

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: ğŸ’° Cache
      uses: Swatinem/rust-cache@v2
      with:
        prefix-key: v0-bench
        save-if: ${{ github.ref == 'refs/heads/main' }}

    - name: Install shells (zsh, fish)
      run: |
        sudo apt-get update
        sudo apt-get install -y zsh fish

    - name: ğŸ“Š Run benchmarks
      uses: clechasseur/rs-cargo@v4
      with:
        command: bench
        # Run completion benchmarks (list has slow real_repo tests)
        args: --locked --bench completion -- --warm-up-time 0.3 --measurement-time 1
