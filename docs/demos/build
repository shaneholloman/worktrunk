#!/usr/bin/env python3
"""Unified build script for demo GIFs.

Usage:
    ./build docs                    # Build doc site demos (light + dark, 1600x900)
    ./build twitter                 # Build Twitter demos (light only, 1200x700)
    ./build docs --only wt-merge    # Build specific demo for docs
    ./build twitter --only wt-zellij --shell  # Debug shell for Twitter demo
"""

import argparse
import os
import subprocess
import sys
from pathlib import Path

# Add docs/demos/ to path for shared library
SCRIPT_DIR = Path(__file__).parent
sys.path.insert(0, str(SCRIPT_DIR))

from shared import (
    VALIDATION_RS,
    DemoEnv, DemoSize, git, prepare_demo_repo,
    setup_claude_code_config, setup_zellij_config, setup_fish_config,
    check_dependencies, setup_demo_output, record_all_themes,
    SIZE_DOCS, SIZE_TWITTER,
)

REPO_ROOT = SCRIPT_DIR.parent.parent
OUT_DIR = SCRIPT_DIR / "out"
TAPES_DIR = SCRIPT_DIR / "tapes"

# Sizes
SIZE_ZELLIJ = DemoSize(width=1200, height=700, fontsize=16)
SIZE_DEVSERVER = DemoSize(width=1400, height=700, fontsize=24)  # Wider to show URL column

# Custom VHS binary with keystroke overlay
VHS_KEYSTROKES = os.environ.get(
    "VHS_KEYSTROKES",
    str(SCRIPT_DIR / "vhs-keystrokes" / "vhs-keystrokes")
)


# =============================================================================
# Setup Helpers
# =============================================================================

def _add_billing_branch(env: DemoEnv):
    """Add a billing branch at same commit as main (merged state)."""
    branch = "billing"
    path = env.work_base / f"acme.{branch}"
    git(["-C", str(env.repo), "worktree", "add", "-q", "-b", branch, str(path), "main"])
    git(["-C", str(path), "push", "-u", "origin", branch, "-q"])


def _add_staged_validation(env: DemoEnv):
    """Add validation.rs with staged changes to hooks branch."""
    hooks_path = env.work_base / "acme.hooks"
    if hooks_path.exists():
        new_file = hooks_path / "src" / "validation.rs"
        new_file.write_text(VALIDATION_RS)
        git(["-C", str(hooks_path), "add", "src/validation.rs"])


def _write_user_config(env: DemoEnv, approved_commands: list[str], commit_generation: bool = False):
    """Write worktrunk user config."""
    config_dir = env.home / ".config" / "worktrunk"
    project_id = str(env.bare_remote).removesuffix(".git")

    content = ""
    if commit_generation:
        content += '''[commit-generation]
command = "llm"
args = ["-m", "claude-haiku-4.5"]

'''
    content += f'[projects."{project_id}"]\n'
    content += f'approved-commands = {approved_commands!r}\n'

    (config_dir / "config.toml").write_text(content)


# =============================================================================
# Demo Setup Functions
# =============================================================================

def prepare_basic(env: DemoEnv):
    """Basic repo setup - no hooks, no extras."""
    prepare_demo_repo(env, REPO_ROOT)


def prepare_with_hooks(env: DemoEnv, include_deps: bool = False):
    """Standard hooks demo: dev server + cleanup + billing branch."""
    dev_cmd = "npm run dev -- --port {{ branch | hash_port }}"
    cleanup_cmd = "flyctl scale count 0"

    if include_deps:
        hooks_config = f'''[post-start]
deps = "npm install"
dev = "{dev_cmd}"

[pre-remove]
cleanup = "{cleanup_cmd}"
'''
        approved = ["npm install", dev_cmd, cleanup_cmd]
    else:
        hooks_config = f'''[post-start]
dev = "{dev_cmd}"

[pre-remove]
cleanup = "{cleanup_cmd}"
'''
        approved = [dev_cmd, cleanup_cmd]

    prepare_demo_repo(env, REPO_ROOT, hooks_config=hooks_config)
    _write_user_config(env, approved)
    _add_billing_branch(env)


def prepare_with_llm_commit(env: DemoEnv):
    """LLM commit generation demo with staged changes."""
    prepare_demo_repo(env, REPO_ROOT)
    _write_user_config(env, ["cargo nextest run"], commit_generation=True)
    _add_staged_validation(env)


def prepare_merge_only(env: DemoEnv):
    """Merge demo without LLM commit generation."""
    prepare_demo_repo(env, REPO_ROOT)
    _write_user_config(env, ["cargo nextest run"])


def prepare_switch(env: DemoEnv):
    """Switch demo with Claude Code UI."""
    hooks_config = '[post-start]\ndeps = "npm install"\n'
    prepare_demo_repo(env, REPO_ROOT, hooks_config=hooks_config)
    _write_user_config(env, ["npm install"])

    setup_claude_code_config(env, [
        str(env.repo),
        str(env.work_base / "acme.alpha"),
        str(env.work_base / "acme.dashboard"),
    ])


def prepare_devserver(env: DemoEnv):
    """Setup for wt-devserver demo - shows URL column in wt list."""
    dev_cmd = "npm run dev -- --port {{ branch | hash_port }} &"
    hooks_config = f'''[post-start]
dev = "{dev_cmd}"

[list]
url = "http://localhost:{{{{ branch | hash_port }}}}"
'''
    prepare_demo_repo(env, REPO_ROOT, hooks_config=hooks_config)
    _write_user_config(env, [dev_cmd])

    # Override npm mock to start nc listener so URL appears active
    npm_mock = env.home / "bin" / "npm"
    npm_mock.write_text("""#!/bin/bash
if [[ "$1" == "run" && "$2" == "dev" ]]; then
    PORT="$5"
    echo ""
    echo "  VITE v5.4.2  ready in 342 ms"
    echo ""
    echo "  âžœ  Local:   http://localhost:$PORT/"
    # Start nc listener so wt list shows URL as active (not dimmed)
    nc -l "$PORT" >/dev/null 2>&1 &
fi
""")
    npm_mock.chmod(0o755)


def prepare_zellij(env: DemoEnv):
    """Setup for wt-zellij demo - multiple Claude Code instances in Zellij tabs."""
    prepare_demo_repo(env, REPO_ROOT, hooks_config='')

    # Zellij + Fish configs
    setup_zellij_config(env)
    setup_fish_config(env, REPO_ROOT, wsl_create=False)  # No --create, worktrees pre-created

    # Claude Code config with pre-approved tools
    worktree_branches = ["api", "billing", "auth", "metrics"]
    worktree_paths = [str(env.repo)] + [
        str(env.work_base / f"acme.{branch}") for branch in worktree_branches
    ]
    allowed_tools = ["Bash", "Read", "Write", "Edit", "Glob", "Grep", "Task", "TodoWrite"]
    setup_claude_code_config(env, worktree_paths, allowed_tools)

    # Pre-create ALL worktrees before recording
    demo_env = {**os.environ, "HOME": str(env.home)}
    for branch in worktree_branches:
        subprocess.run(
            ["wt", "switch", "--create", branch],
            cwd=str(env.repo),
            env=demo_env,
            capture_output=True
        )

    # Add uncommitted changes to api worktree for git diff demo
    api_lib = env.work_base / "acme.api" / "src" / "lib.rs"
    if api_lib.exists():
        content = api_lib.read_text()
        content = content.replace('pub fn add(', '// TODO: Add input validation\npub fn add(')
        content += '\npub fn validate_input(n: i32) -> bool {\n    n >= 0 && n < 1000\n}\n'
        api_lib.write_text(content)


def prepare_zellij_omnibus(env: DemoEnv):
    """Setup for wt-zellij-omnibus demo - comprehensive showcase."""
    hooks_config = '''[post-start]
dev = "npm run dev -- --port {{ branch | hash_port }} &"

[pre-merge]
test = "cargo nextest run"

[list]
url = "http://localhost:{{ branch | hash_port }}"
'''
    prepare_demo_repo(env, REPO_ROOT, hooks_config=hooks_config)

    # Enable git colors for non-TTY environments (VHS)
    git(["-C", str(env.repo), "config", "color.ui", "always"])

    # Override llm mock with different commit message for this demo
    llm_mock = env.home / "bin" / "llm"
    llm_mock.write_text("""#!/bin/bash
sleep 0.5
echo "feat: add user settings module"
echo ""
echo "Add placeholder module for user profile settings."
""")
    llm_mock.chmod(0o755)

    # User config with LLM commit generation
    _write_user_config(
        env,
        ["npm run dev -- --port {{ branch | hash_port }} &", "cargo nextest run"],
        commit_generation=True
    )

    # Zellij + Fish configs (with --create in wsl abbreviation)
    setup_zellij_config(env, default_cwd=str(env.repo))
    setup_fish_config(env, REPO_ROOT, wsl_create=True)

    # Claude Code config with pre-approved tools
    worktree_branches = ["api", "auth", "billing", "feature"]
    worktree_paths = [str(env.repo)] + [
        str(env.work_base / f"acme.{branch}") for branch in worktree_branches
    ]
    allowed_tools = ["Bash", "Read", "Write", "Edit", "Glob", "Grep", "Task", "TodoWrite"]
    setup_claude_code_config(env, worktree_paths, allowed_tools)

    # Pre-create worktrees (api and auth only - billing created during demo)
    demo_env = {
        **os.environ,
        "HOME": str(env.home),
        "PATH": f"{REPO_ROOT}/target/debug:{env.home}/bin:{os.environ.get('PATH', '')}"
    }

    def run_wt(args, cwd):
        result = subprocess.run(["wt"] + args, cwd=str(cwd), env=demo_env, capture_output=True, text=True)
        if result.returncode != 0:
            raise RuntimeError(f"wt {' '.join(args)} failed: {result.stderr}")

    run_wt(["switch", "--create", "api"], env.repo)
    git(["-C", str(env.work_base / "acme.api"), "push", "-u", "origin", "api", "-q"])

    run_wt(["switch", "--create", "auth"], env.repo)
    git(["-C", str(env.work_base / "acme.auth"), "push", "-u", "origin", "auth", "-q"])

    # Return to main worktree for the demo to start
    run_wt(["switch", "main"], env.work_base / "acme.api")


# =============================================================================
# Demo Registrations
# =============================================================================

# Format: (tape_file, output_name, setup_func, vhs_type, size_override)
# size_override is optional - if None, uses target default

DOCS_DEMOS = [
    ("wt-core.tape", "wt-core", prepare_with_hooks, "vhs", None),
    ("wt-merge.tape", "wt-merge", prepare_with_llm_commit, "vhs", None),
    ("wt-select.tape", "wt-select", prepare_basic, "vhs-keystrokes", None),
    ("wt-zellij-omnibus.tape", "wt-zellij-omnibus", prepare_zellij_omnibus, "vhs", None),
]

TWITTER_DEMOS = [
    ("wt-switch.tape", "wt-switch", prepare_switch, "vhs", None),
    ("wt-statusline.tape", "wt-statusline", prepare_switch, "vhs", None),
    ("wt-list.tape", "wt-list", prepare_with_hooks, "vhs", None),
    ("wt-list-remove.tape", "wt-list-remove", prepare_with_hooks, "vhs", None),
    ("wt-hooks.tape", "wt-hooks", lambda env: prepare_with_hooks(env, include_deps=True), "vhs", None),
    ("wt-devserver.tape", "wt-devserver", prepare_devserver, "vhs", SIZE_DEVSERVER),
    ("wt-commit.tape", "wt-commit", prepare_with_llm_commit, "vhs", None),
    ("wt-merge.tape", "wt-merge", prepare_merge_only, "vhs", None),
    ("wt-select-short.tape", "wt-select-short", prepare_basic, "vhs-keystrokes", None),
    ("wt-core.tape", "wt-core", prepare_with_hooks, "vhs", None),
    ("wt-zellij.tape", "wt-zellij", prepare_zellij, "vhs", SIZE_ZELLIJ),
    ("wt-zellij-omnibus.tape", "wt-zellij-omnibus", prepare_zellij_omnibus, "vhs", SIZE_ZELLIJ),
]

TARGETS = {
    "docs": {
        "demos": DOCS_DEMOS,
        "default_size": SIZE_DOCS,
        "themes": ["light", "dark"],
    },
    "twitter": {
        "demos": TWITTER_DEMOS,
        "default_size": SIZE_TWITTER,
        "themes": ["light"],
    },
}


# =============================================================================
# Main
# =============================================================================

def spawn_debug_shell(env: DemoEnv, starship_config: Path):
    """Spawn an interactive fish shell with the demo environment set up."""
    shell_env = os.environ.copy()
    shell_env.update({
        "HOME": str(env.home),
        "XDG_CONFIG_HOME": str(env.home / ".config"),
        "STARSHIP_CONFIG": str(starship_config),
        "PATH": f"{REPO_ROOT / 'target' / 'debug'}:{env.home / 'bin'}:{os.environ.get('PATH', '')}",
        # Keep real rustup/cargo for any rust tools
        "RUSTUP_HOME": str(Path.home() / ".rustup"),
        "CARGO_HOME": str(Path.home() / ".cargo"),
    })

    print(f"\nSpawning fish shell in demo environment...")
    print(f"  HOME={env.home}")
    print(f"  Demo repo: {env.repo}\n")

    init_cmd = "starship init fish | source; wt config shell init fish | source"
    subprocess.run(["fish", "-C", init_cmd], env=shell_env, cwd=str(env.repo))


def main():
    parser = argparse.ArgumentParser(
        description="Build demo GIFs for worktrunk",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  ./build docs                    Build all doc site demos (light + dark)
  ./build twitter                 Build all Twitter demos (light only)
  ./build docs --only wt-merge    Build specific demo for docs
  ./build twitter --only wt-zellij --shell   Debug shell for demo
"""
    )
    parser.add_argument("target", choices=["docs", "twitter"],
                        help="Target to build demos for")
    parser.add_argument("--only", help="Only record specific demo (e.g., wt-switch)")
    parser.add_argument("--shell", action="store_true",
                        help="Build demo and spawn interactive shell for debugging (requires --only)")
    args = parser.parse_args()

    if args.shell and not args.only:
        print("--shell requires --only to specify which demo to debug")
        return

    # Check dependencies
    deps = ["wt", "vhs", "starship", "zellij"]
    check_dependencies(deps)

    starship_config = setup_demo_output(OUT_DIR)

    target_config = TARGETS[args.target]
    demos = target_config["demos"]
    default_size = target_config["default_size"]
    themes = target_config["themes"]

    # Filter demos if --only specified
    if args.only:
        demos = [(t, n, s, v, sz) for t, n, s, v, sz in demos if n == args.only]
        if not demos:
            all_names = [n for _, n, _, _, _ in target_config["demos"]]
            print(f"Unknown demo: {args.only}")
            print(f"Available for {args.target}: {', '.join(all_names)}")
            return

    # Check vhs-keystrokes availability
    vhs_keystrokes_available = Path(VHS_KEYSTROKES).exists()
    needs_keystrokes = any(vhs_type == "vhs-keystrokes" for _, _, _, vhs_type, _ in demos)

    if needs_keystrokes and not vhs_keystrokes_available:
        print(f"Error: vhs-keystrokes required but not found", file=sys.stderr)
        print(f"Not found at: {VHS_KEYSTROKES}", file=sys.stderr)
        print("See docs/demos/CLAUDE.md for build instructions", file=sys.stderr)
        sys.exit(1)

    # Record each demo
    for tape_file, output_name, setup_func, vhs_type, size_override in demos:
        tape_path = TAPES_DIR / tape_file
        if not tape_path.exists():
            print(f"Skipping {output_name}: {tape_file} not found")
            continue

        vhs_binary = VHS_KEYSTROKES if vhs_type == "vhs-keystrokes" else "vhs"
        demo_size = size_override or default_size

        # Build output GIF paths based on themes
        output_gifs = {"light": OUT_DIR / f"{output_name}.gif"}
        if "dark" in themes:
            output_gifs["dark"] = OUT_DIR / f"{output_name}-dark.gif"

        print(f"\n{'='*60}")
        print(f"Recording {output_name} ({args.target})...")
        print(f"{'='*60}")

        # Create fresh environment for each demo
        # Use /private/tmp for Zellij demos to isolate Claude instances
        demo_out_dir = Path("/private/tmp/wt-demos") if output_name.startswith("wt-zellij") else OUT_DIR
        setup_demo_output(demo_out_dir)
        env = DemoEnv(name=output_name, out_dir=demo_out_dir, repo_name="acme")
        setup_func(env)

        print(f"Demo repo: {env.repo}")

        if args.shell:
            spawn_debug_shell(env, starship_config)
            return  # Only debug one demo at a time

        record_all_themes(env, tape_path, output_gifs, REPO_ROOT, vhs_binary=vhs_binary, size=demo_size)


if __name__ == "__main__":
    main()
