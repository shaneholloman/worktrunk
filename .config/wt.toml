# Post-start hooks for worktree setup
# These run after creating a new worktree
#
# Available template variables:
#   {{ repo }}      - Repository name (e.g., "worktrunk.project-config")
#   {{ branch }}    - Branch name with slashes replaced by dashes
#   {{ worktree }}  - Path to the new worktree
#   {{ repo_root }} - Path to the main repository root
# Post-start commands run in parallel after switching to a worktree
[post-start]
# Seed compiled dependencies from base worktree using CoW (copy-on-write)
# Copies essential files (~7.5k), skipping 184k+ .rcgu.o incremental objects
# Result: ~3 seconds instead of ~68 seconds
# macOS: uses cp -c (clonefile on APFS)
deps = """
[ -d {{ repo_root }}/target/debug/deps ] && [ ! -e target ] &&
mkdir -p target/debug/deps &&
cp -c {{ repo_root }}/target/debug/deps/*.rlib {{ repo_root }}/target/debug/deps/*.rmeta target/debug/deps/ &&
cp -cR {{ repo_root }}/target/debug/.fingerprint {{ repo_root }}/target/debug/build target/debug/
"""
# Fetch demo assets for docs development
assets = "./scripts/fetch-assets"

# Post-merge hooks
# These run in the main worktree after successful merge and push
# Available template variables: {{ repo }}, {{ branch }}, {{ worktree }}, {{ repo_root }}, {{ target }}
[post-merge]
build = "cargo build --all-targets"
install = "cargo install --path ."
sync = 'if [ "{{ target }}" = "main" ]; then git pull && git push; fi'

# Pre-commit hooks
# These run sequentially before committing changes during merge (both squash and no-squash)
# All commands must exit with code 0 for commit to proceed
[pre-commit]
pre-commit = "pre-commit run --all-files"

# Pre-merge hooks
# These run sequentially before merging to main
# All commands must exit with code 0 for merge to proceed
# Note: This must come AFTER post-merge because [pre-merge] starts
# a TOML table section, and everything after it would be inside that section
[pre-merge]
insta = "RUSTFLAGS='-D warnings' NEXTEST_STATUS_LEVEL=fail NEXTEST_SUCCESS_OUTPUT=never cargo insta test --dnd --check --features shell-integration-tests"
doctest = "cargo test --doc"
doc = "RUSTDOCFLAGS='-Dwarnings' cargo doc --no-deps"
